<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upgrade Fabi</title>

</head>

<body>
  <h1>Fabi upgrade site</h1>
  <!-- TEMPORARY: Mobile DevTools for iPhone Testing -->
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>
  eruda.init();
</script>
</body>

<script type="text/javascript">
/**
 * Embedded Messaging Input Control - Host Page Script
 * ROLLBACK VERSION: sessionStorage (worked on desktop)
 */

// ============================================================================
// CONFIGURATION
// ============================================================================

let agentCount = 0;
let lastBotMessageAllowedInput = false;
let botOpened = false;

const BOT_FLAG_ENABLE = 'â¤';
const EVENT_PARTICIPANT_CHANGED = 'ParticipantChanged';
const EVENT_OP_ADD = '"operation":"add"';
const EVENT_OP_REMOVE = '"operation":"remove"';
const EVENT_ROLE_AGENT = '"role":"Agent"';
const EVENT_CLOSE_CONVERSATION = '"entryType":"CloseConversation"';

const SESSION_KEY_INPUT_ENABLED = 'embeddedMessaging_inputEnabled';
const SESSION_KEY_AGENT_COUNT = 'embeddedMessaging_agentCount';
const SESSION_KEY_BOT_ALLOWED = 'embeddedMessaging_botAllowed';

// ============================================================================
// IFRAME COMMUNICATION
// ============================================================================

function getIframe() {
  return document.getElementById("embeddedMessagingFrame")?.contentWindow || null;
}

function postIframeMessage(message) {
  const iframeWindow = getIframe();
  if (iframeWindow) {
    iframeWindow.postMessage(message, "*");
    console.log('ğŸ“¤ Host: Sent message to iframe:', message);
  } else {
    console.log('â¸ï¸ Host: Bot not opened yet, message queued:', message);
  }
}

// ============================================================================
// STATE PERSISTENCE (Page Refresh Support)
// ============================================================================

window.addEventListener('beforeunload', () => {
  try {
    if (botOpened) {
      const inputEnabled = (agentCount > 0 || lastBotMessageAllowedInput) ? '1' : '0';
      sessionStorage.setItem(SESSION_KEY_INPUT_ENABLED, inputEnabled);
      sessionStorage.setItem(SESSION_KEY_AGENT_COUNT, agentCount.toString());
      sessionStorage.setItem(SESSION_KEY_BOT_ALLOWED, lastBotMessageAllowedInput ? '1' : '0');
      console.log('ğŸ’¾ Host: Saved state before unload:', { inputEnabled, agentCount, lastBotMessageAllowedInput });
    }
  } catch (err) {
    console.error('âŒ Host: Failed to save state:', err);
  }
});

function restoreStateFromSession() {
  try {
    const savedInputState = sessionStorage.getItem(SESSION_KEY_INPUT_ENABLED);
    const savedAgentCount = sessionStorage.getItem(SESSION_KEY_AGENT_COUNT);
    const savedBotAllowed = sessionStorage.getItem(SESSION_KEY_BOT_ALLOWED);
    
    console.log('ğŸ” Host: Session storage values:', {
      inputEnabled: savedInputState,
      agentCount: savedAgentCount,
      botAllowed: savedBotAllowed
    });
    
    if (savedInputState === null && savedAgentCount === null && savedBotAllowed === null) {
      console.log('ğŸ“ Host: No previous session state found');
      return false;
    }
    
    if (savedAgentCount !== null) {
      agentCount = parseInt(savedAgentCount, 10) || 0;
      console.log('ğŸ”„ Host: Restored agentCount:', agentCount);
    }
    
    if (savedBotAllowed !== null) {
      lastBotMessageAllowedInput = savedBotAllowed === '1';
      console.log('ğŸ”„ Host: Restored lastBotMessageAllowedInput:', lastBotMessageAllowedInput);
    }
    
    if (savedInputState === '1' && (agentCount > 0 || lastBotMessageAllowedInput)) {
      console.log('âœ… Host: Page refresh - will restore ENABLED state when bot opens');
      return true;
    } else {
      console.log('ğŸ”’ Host: Page refresh - will restore DISABLED state when bot opens');
      return false;
    }
  } catch (err) {
    console.error('âŒ Host: Failed to restore state:', err);
    return false;
  }
}

const shouldRestoreEnabled = restoreStateFromSession();

setTimeout(() => {
  try {
    sessionStorage.removeItem(SESSION_KEY_INPUT_ENABLED);
    sessionStorage.removeItem(SESSION_KEY_AGENT_COUNT);
    sessionStorage.removeItem(SESSION_KEY_BOT_ALLOWED);
    console.log('ğŸ§¹ Host: Cleared session storage after 5 minutes');
  } catch (err) {
    console.error('âŒ Host: Failed to clear session storage:', err);
  }
}, 300000);

// ============================================================================
// MESSAGE EVENT HANDLER
// ============================================================================

window.addEventListener("message", function(event) {
  try {
    if (event.data === "iframe-ready") {
      console.log('âœ… Host: Bot opened - iframe ready signal received');
      botOpened = true;
      
      if (shouldRestoreEnabled && (agentCount > 0 || lastBotMessageAllowedInput)) {
        postIframeMessage("InputEnable");
        console.log('ğŸ”“ Host: Restored enabled state after page refresh');
      } else {
        postIframeMessage("InputDisable");
        console.log('ğŸ”’ Host: Applied disabled state on bot open');
      }
      return;
    }
    
    const details = event?.data?.data?.eventDetails?.conversationEntry;
    const payload = details?.entryPayload;
    const entryType = details?.entryType;
    const senderRole = details?.sender?.role;
    
    if (typeof payload !== "string") {
      return;
    }
    
    if (!botOpened) {
      botOpened = true;
      console.log('âœ… Host: Bot opened - conversation events detected');
    }
    
    if (entryType === EVENT_PARTICIPANT_CHANGED) {
      if (payload.includes(EVENT_OP_ADD) && payload.includes(EVENT_ROLE_AGENT)) {
        agentCount++;
        console.log('ğŸ‘¤ Host: Agent joined (count:', agentCount + ')');
      } else if (payload.includes(EVENT_OP_REMOVE) && payload.includes(EVENT_ROLE_AGENT)) {
        agentCount--;
        console.log('ğŸ‘‹ Host: Agent left (count:', agentCount + ')');
      }
    }
    
    if (agentCount > 0) {
      postIframeMessage("InputEnable");
      lastBotMessageAllowedInput = false;
      return;
    }
    
    if (senderRole === "Chatbot" && payload.includes(BOT_FLAG_ENABLE)) {
      postIframeMessage("InputEnable");
      lastBotMessageAllowedInput = true;
      console.log('ğŸ¤– Host: Bot requested free-text input');
      return;
    }
    
    if (senderRole === "Chatbot" && !payload.includes(BOT_FLAG_ENABLE)) {
      postIframeMessage("InputDisable");
      lastBotMessageAllowedInput = false;
      console.log('ğŸ¤– Host: Bot in scripted mode (no free-text)');
      return;
    }
    
    if (payload.includes(EVENT_CLOSE_CONVERSATION)) {
      postIframeMessage("InputDisable");
      lastBotMessageAllowedInput = false;
      agentCount = 0;
      console.log('ğŸ”š Host: Conversation closed');
      return;
    }
    
  } catch (err) {
    console.error("âŒ Host: Error processing message event:", err);
    postIframeMessage("InputDisable");
  }
});

console.log('ğŸš€ Host: Input control script initialized (waiting for user to open bot)');
</script>
</html>