<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upgrade Fabi</title>

</head>

<body>
  <h1>Fabi upgrade site</h1>
  
  <!-- TEMPORARY: Mobile DevTools for iPhone Testing -->
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

</body>
</html>
</body>

<script type="text/javascript">
/**
 * Embedded Messaging Input Control - Host Page Script
 * Environment: PREVIEW/TEST (connects to upgrade or test sandboxes)
 * iOS FIX: Uses localStorage for better persistence on iOS Safari
 * SECURITY: Origin validation with exact allowlists
 * VERSION: 2.0 - Production Ready
 */

(function() {
  'use strict';
  
  // ============================================================================
  // ENVIRONMENT-SPECIFIC CONFIGURATION
  // ============================================================================
  // For preview/test sites that connect to UPGRADE or TEST sandboxes
  
  const ALLOWED_SALESFORCE_ORIGINS = [
    // UPGRADE sandbox origins
    'https://pfizermedinfo--upgrade.sandbox.my.salesforce.com',
    'https://pfizermedinfo--upgrade.sandbox.my.site.com',
    'https://pfizermedinfo--upgrade--c.sandbox.vf.force.com',
    // TEST sandbox origins
    'https://pfizermedinfo--test.sandbox.my.salesforce.com',
    'https://pfizermedinfo--test.sandbox.my.site.com',
    'https://pfizermedinfo--test--c.sandbox.vf.force.com'
  ];
  
  // ============================================================================
  // CONFIGURATION CONSTANTS
  // ============================================================================
  
  const STATE_SAVE_INTERVAL_MS = 2000;
  const STATE_EXPIRATION_MS = 10 * 60 * 1000;
  
  const BOT_FLAG_ENABLE = '‚û§';
  const EVENT_PARTICIPANT_CHANGED = 'ParticipantChanged';
  const EVENT_OP_ADD = '"operation":"add"';
  const EVENT_OP_REMOVE = '"operation":"remove"';
  const EVENT_ROLE_AGENT = '"role":"Agent"';
  const EVENT_CLOSE_CONVERSATION = '"entryType":"CloseConversation"';
  
  const STORAGE_KEY_PREFIX = 'embMsg_';
  const STORAGE_KEY_INPUT_ENABLED = STORAGE_KEY_PREFIX + 'inputEnabled';
  const STORAGE_KEY_AGENT_COUNT = STORAGE_KEY_PREFIX + 'agentCount';
  const STORAGE_KEY_BOT_ALLOWED = STORAGE_KEY_PREFIX + 'botAllowed';
  const STORAGE_KEY_TIMESTAMP = STORAGE_KEY_PREFIX + 'timestamp';
  
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  
  console.log('üîç Host: Device detected - iOS:', isIOS);
  console.log('üîç Host: Environment: PREVIEW/TEST (Upgrade + Test sandboxes)');
  
  // ============================================================================
  // STATE VARIABLES
  // ============================================================================
  
  let agentCount = 0;
  let lastBotMessageAllowedInput = false;
  let botOpened = false;
  
  // ============================================================================
  // ORIGIN VALIDATION
  // ============================================================================
  
  function isValidSalesforceOrigin(origin) {
    if (origin === 'null' || origin.startsWith('file://')) {
      console.warn('‚ö†Ô∏è Host: Local development detected - origin validation relaxed');
      return true;
    }
    
    const isValid = ALLOWED_SALESFORCE_ORIGINS.includes(origin);
    
    if (!isValid) {
      console.error('üö® Security: Blocked postMessage from unauthorized origin:', origin);
      console.error('   Expected one of:', ALLOWED_SALESFORCE_ORIGINS);
    }
    
    return isValid;
  }
  
  // ============================================================================
  // LOCALSTORAGE AVAILABILITY CHECK
  // ============================================================================
  
  function isLocalStorageAvailable() {
    try {
      const test = '__storage_test__';
      localStorage.setItem(test, test);
      localStorage.removeItem(test);
      return true;
    } catch(e) {
      console.error('‚ùå Host: localStorage not available:', e);
      return false;
    }
  }
  
  const localStorageAvailable = isLocalStorageAvailable();
  
  if (!localStorageAvailable) {
    console.warn('‚ö†Ô∏è Host: localStorage disabled - state persistence unavailable');
  }
  
  // ============================================================================
  // IFRAME COMMUNICATION
  // ============================================================================
  
  function getIframe() {
    try {
      return document.getElementById("embeddedMessagingFrame")?.contentWindow || null;
    } catch (err) {
      console.error('‚ùå Host: Error accessing iframe:', err);
      return null;
    }
  }
  
  function postIframeMessage(message) {
    try {
      const iframeWindow = getIframe();
      if (iframeWindow) {
        iframeWindow.postMessage(message, "*");
        console.log('üì§ Host: Sent message to iframe:', message);
      } else {
        console.log('‚è∏Ô∏è Host: Bot not opened yet, message queued:', message);
      }
    } catch (err) {
      console.error('‚ùå Host: Error sending iframe message:', err);
    }
  }
  
  // ============================================================================
  // STATE PERSISTENCE
  // ============================================================================
  
  function saveState() {
    if (!localStorageAvailable) {
      return;
    }
    
    try {
      if (!botOpened) {
        return;
      }
      
      const inputEnabled = (agentCount > 0 || lastBotMessageAllowedInput) ? '1' : '0';
      const timestamp = new Date().getTime();
      
      console.log('üíæ Host: Saving state:', {
        inputEnabled: inputEnabled,
        agentCount: agentCount,
        lastBotMessageAllowedInput: lastBotMessageAllowedInput
      });
      
      localStorage.setItem(STORAGE_KEY_INPUT_ENABLED, inputEnabled);
      localStorage.setItem(STORAGE_KEY_AGENT_COUNT, agentCount.toString());
      localStorage.setItem(STORAGE_KEY_BOT_ALLOWED, lastBotMessageAllowedInput ? '1' : '0');
      localStorage.setItem(STORAGE_KEY_TIMESTAMP, timestamp.toString());
      
      console.log('‚úÖ Host: State saved to localStorage');
      
    } catch (err) {
      console.error('‚ùå Host: Failed to save state:', err);
    }
  }
  
  function restoreStateFromStorage() {
    if (!localStorageAvailable) {
      return false;
    }
    
    try {
      console.log('üîç Host: Checking localStorage for saved state...');
      
      const savedInputState = localStorage.getItem(STORAGE_KEY_INPUT_ENABLED);
      const savedAgentCount = localStorage.getItem(STORAGE_KEY_AGENT_COUNT);
      const savedBotAllowed = localStorage.getItem(STORAGE_KEY_BOT_ALLOWED);
      const savedTimestamp = localStorage.getItem(STORAGE_KEY_TIMESTAMP);
      
      console.log('üîç Host: localStorage values:', {
        inputEnabled: savedInputState,
        agentCount: savedAgentCount,
        botAllowed: savedBotAllowed,
        timestamp: savedTimestamp
      });
      
      if (savedTimestamp) {
        const age = new Date().getTime() - parseInt(savedTimestamp, 10);
        const ageMinutes = Math.floor(age / 60000);
        console.log('üïê Host: Saved state age:', ageMinutes, 'minutes');
        
        if (age > STATE_EXPIRATION_MS) {
          console.log('‚è∞ Host: Saved state too old, ignoring');
          clearSavedState();
          return false;
        }
      }
      
      if (savedInputState === null && savedAgentCount === null && savedBotAllowed === null) {
        console.log('üìù Host: No previous state found in localStorage');
        return false;
      }
      
      if (savedAgentCount !== null) {
        agentCount = parseInt(savedAgentCount, 10) || 0;
        console.log('üîÑ Host: Restored agentCount:', agentCount);
      }
      
      if (savedBotAllowed !== null) {
        lastBotMessageAllowedInput = savedBotAllowed === '1';
        console.log('üîÑ Host: Restored lastBotMessageAllowedInput:', lastBotMessageAllowedInput);
      }
      
      if (savedInputState === '1' && (agentCount > 0 || lastBotMessageAllowedInput)) {
        console.log('‚úÖ Host: Page refresh - will restore ENABLED state when bot opens');
        return true;
      } else {
        console.log('üîí Host: Page refresh - will restore DISABLED state when bot opens');
        return false;
      }
    } catch (err) {
      console.error('‚ùå Host: Failed to restore state:', err);
      return false;
    }
  }
  
  function clearSavedState() {
    if (!localStorageAvailable) {
      return;
    }
    
    try {
      localStorage.removeItem(STORAGE_KEY_INPUT_ENABLED);
      localStorage.removeItem(STORAGE_KEY_AGENT_COUNT);
      localStorage.removeItem(STORAGE_KEY_BOT_ALLOWED);
      localStorage.removeItem(STORAGE_KEY_TIMESTAMP);
      console.log('üßπ Host: Cleared saved state from localStorage');
    } catch (err) {
      console.error('‚ùå Host: Failed to clear saved state:', err);
    }
  }
  
  // ============================================================================
  // STATE PERSISTENCE EVENT HANDLERS
  // ============================================================================
  
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden' && botOpened) {
      console.log('üëÅÔ∏è Host: Page hidden, saving state...');
      saveState();
    }
  });
  
  window.addEventListener('beforeunload', () => {
    console.log('üö™ Host: beforeunload fired, saving state...');
    saveState();
  });
  
  window.addEventListener('pagehide', () => {
    console.log('‚ùÑÔ∏è Host: pagehide fired, saving state...');
    saveState();
  });
  
  setInterval(() => {
    if (botOpened) {
      saveState();
    }
  }, STATE_SAVE_INTERVAL_MS);
  
  const shouldRestoreEnabled = restoreStateFromStorage();
  
  setTimeout(() => {
    clearSavedState();
  }, STATE_EXPIRATION_MS);
  
  // ============================================================================
  // MESSAGE EVENT HANDLER (WITH ORIGIN VALIDATION)
  // ============================================================================
  
  window.addEventListener("message", function(event) {
    try {
      if (event.data === "iframe-ready") {
        console.log('‚úÖ Host: Bot opened - iframe ready signal received from:', event.origin);
        
        if (!isValidSalesforceOrigin(event.origin)) {
          console.error('üö® Security: Rejected iframe-ready from unauthorized origin');
          return;
        }
        
        botOpened = true;
        
        if (shouldRestoreEnabled && (agentCount > 0 || lastBotMessageAllowedInput)) {
          postIframeMessage("InputEnable");
          console.log('üîì Host: Restored enabled state after page refresh');
        } else {
          postIframeMessage("InputDisable");
          console.log('üîí Host: Applied disabled state on bot open');
        }
        
        saveState();
        return;
      }
      
      if (!isValidSalesforceOrigin(event.origin)) {
        return;
      }
      
      const details = event?.data?.data?.eventDetails?.conversationEntry;
      const payload = details?.entryPayload;
      const entryType = details?.entryType;
      const senderRole = details?.sender?.role;
      
      if (typeof payload !== "string") {
        return;
      }
      
      if (!botOpened) {
        botOpened = true;
        console.log('‚úÖ Host: Bot opened - conversation events detected');
      }
      
      if (entryType === EVENT_PARTICIPANT_CHANGED) {
        if (payload.includes(EVENT_OP_ADD) && payload.includes(EVENT_ROLE_AGENT)) {
          agentCount++;
          console.log('üë§ Host: Agent joined (count:', agentCount + ')');
          saveState();
        } else if (payload.includes(EVENT_OP_REMOVE) && payload.includes(EVENT_ROLE_AGENT)) {
          agentCount--;
          console.log('üëã Host: Agent left (count:', agentCount + ')');
          saveState();
        }
      }
      
      if (agentCount > 0) {
        postIframeMessage("InputEnable");
        lastBotMessageAllowedInput = false;
        saveState();
        return;
      }
      
      if (senderRole === "Chatbot" && payload.includes(BOT_FLAG_ENABLE)) {
        postIframeMessage("InputEnable");
        lastBotMessageAllowedInput = true;
        console.log('ü§ñ Host: Bot requested free-text input');
        saveState();
        return;
      }
      
      if (senderRole === "Chatbot" && !payload.includes(BOT_FLAG_ENABLE)) {
        postIframeMessage("InputDisable");
        lastBotMessageAllowedInput = false;
        console.log('ü§ñ Host: Bot in scripted mode (no free-text)');
        saveState();
        return;
      }
      
      if (payload.includes(EVENT_CLOSE_CONVERSATION)) {
        postIframeMessage("InputDisable");
        lastBotMessageAllowedInput = false;
        agentCount = 0;
        console.log('üîö Host: Conversation closed');
        clearSavedState();
        return;
      }
      
    } catch (err) {
      console.error("‚ùå Host: Error processing message event:", err);
      postIframeMessage("InputDisable");
    }
  });
  
  console.log('üöÄ Host: Input control script initialized');
  
})();
</script>

<!-- Embedded Messaging Bootstrap Script -->
<script type='text/javascript'>

  window.addEventListener("onEmbeddedMessagingReady", e => {
    embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
      input_Country: "BR",
      input_ISOCountry: "BR",
      input_ChannelDetails: "FABI - Website | Corporate"
    });
  });
  
	function initEmbeddedMessaging() {
		try {
			embeddedservice_bootstrap.settings.language = 'pt_BR'; // For example, enter 'en' or 'en-US'

			embeddedservice_bootstrap.init(
				'00D9V00000D7QJF',
				'PFZ_BR_Messaging',
				'https://pfizermedinfo--upgrade.sandbox.my.site.com/ESWMessagingforWebBrazil',
				{
					scrt2URL: 'https://pfizermedinfo--upgrade.sandbox.my.salesforce-scrt.com'
				}
			);
		} catch (err) {
			console.error('Error loading Embedded Messaging: ', err);
		}
	};
</script>
<script type='text/javascript' src='https://pfizermedinfo--upgrade.sandbox.my.site.com/ESWMessagingforWebBrazil/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>

</html>