<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upgrade UK HCP</title>

</head>

<body>
  <h1>UK HCP upgrade site</h1>
  <!-- TEMPORARY: Mobile DevTools for iPhone Testing -->
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>
</body>

<script type="text/javascript">
/**
 * Embedded Messaging Input Control - Host Page Script
 * iOS FIX: Uses localStorage for better persistence on iOS Safari
 */

// ============================================================================
// CONFIGURATION
// ============================================================================

let agentCount = 0;
let lastBotMessageAllowedInput = false;
let botOpened = false;

const BOT_FLAG_ENABLE = '‚û§';
const EVENT_PARTICIPANT_CHANGED = 'ParticipantChanged';
const EVENT_OP_ADD = '"operation":"add"';
const EVENT_OP_REMOVE = '"operation":"remove"';
const EVENT_ROLE_AGENT = '"role":"Agent"';
const EVENT_CLOSE_CONVERSATION = '"entryType":"CloseConversation"';

// Use localStorage instead of sessionStorage for iOS compatibility
const STORAGE_KEY_PREFIX = 'embMsg_';
const STORAGE_KEY_INPUT_ENABLED = STORAGE_KEY_PREFIX + 'inputEnabled';
const STORAGE_KEY_AGENT_COUNT = STORAGE_KEY_PREFIX + 'agentCount';
const STORAGE_KEY_BOT_ALLOWED = STORAGE_KEY_PREFIX + 'botAllowed';
const STORAGE_KEY_TIMESTAMP = STORAGE_KEY_PREFIX + 'timestamp';

const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

console.log('üîç Host: Device detected - iOS:', isIOS);

// ============================================================================
// IFRAME COMMUNICATION
// ============================================================================

function getIframe() {
  return document.getElementById("embeddedMessagingFrame")?.contentWindow || null;
}

function postIframeMessage(message) {
  const iframeWindow = getIframe();
  if (iframeWindow) {
    iframeWindow.postMessage(message, "*");
    console.log('üì§ Host: Sent message to iframe:', message);
  } else {
    console.log('‚è∏Ô∏è Host: Bot not opened yet, message queued:', message);
  }
}

// ============================================================================
// STATE PERSISTENCE (localStorage for iOS compatibility)
// ============================================================================

/**
 * Save state using localStorage (more reliable on iOS than sessionStorage)
 */
function saveState() {
  try {
    if (!botOpened) {
      return;
    }
    
    const inputEnabled = (agentCount > 0 || lastBotMessageAllowedInput) ? '1' : '0';
    const timestamp = new Date().getTime();
    
    console.log('üíæ Host: Saving state:', {
      inputEnabled: inputEnabled,
      agentCount: agentCount,
      lastBotMessageAllowedInput: lastBotMessageAllowedInput
    });
    
    localStorage.setItem(STORAGE_KEY_INPUT_ENABLED, inputEnabled);
    localStorage.setItem(STORAGE_KEY_AGENT_COUNT, agentCount.toString());
    localStorage.setItem(STORAGE_KEY_BOT_ALLOWED, lastBotMessageAllowedInput ? '1' : '0');
    localStorage.setItem(STORAGE_KEY_TIMESTAMP, timestamp.toString());
    
    console.log('‚úÖ Host: State saved to localStorage');
    
  } catch (err) {
    console.error('‚ùå Host: Failed to save state:', err);
  }
}

/**
 * Restore state from localStorage
 */
function restoreStateFromStorage() {
  try {
    console.log('üîç Host: Checking localStorage for saved state...');
    
    const savedInputState = localStorage.getItem(STORAGE_KEY_INPUT_ENABLED);
    const savedAgentCount = localStorage.getItem(STORAGE_KEY_AGENT_COUNT);
    const savedBotAllowed = localStorage.getItem(STORAGE_KEY_BOT_ALLOWED);
    const savedTimestamp = localStorage.getItem(STORAGE_KEY_TIMESTAMP);
    
    console.log('üîç Host: localStorage values:', {
      inputEnabled: savedInputState,
      agentCount: savedAgentCount,
      botAllowed: savedBotAllowed,
      timestamp: savedTimestamp
    });
    
    // Check if state is too old (more than 10 minutes)
    if (savedTimestamp) {
      const age = new Date().getTime() - parseInt(savedTimestamp, 10);
      const ageMinutes = Math.floor(age / 60000);
      console.log('üïê Host: Saved state age:', ageMinutes, 'minutes');
      
      if (age > 600000) { // 10 minutes
        console.log('‚è∞ Host: Saved state too old, ignoring');
        clearSavedState();
        return false;
      }
    }
    
    // Check if there's any saved state
    if (savedInputState === null && savedAgentCount === null && savedBotAllowed === null) {
      console.log('üìù Host: No previous state found in localStorage');
      return false;
    }
    
    if (savedAgentCount !== null) {
      agentCount = parseInt(savedAgentCount, 10) || 0;
      console.log('üîÑ Host: Restored agentCount:', agentCount);
    }
    
    if (savedBotAllowed !== null) {
      lastBotMessageAllowedInput = savedBotAllowed === '1';
      console.log('üîÑ Host: Restored lastBotMessageAllowedInput:', lastBotMessageAllowedInput);
    }
    
    // Determine if input should be enabled based on restored state
    if (savedInputState === '1' && (agentCount > 0 || lastBotMessageAllowedInput)) {
      console.log('‚úÖ Host: Page refresh - will restore ENABLED state when bot opens');
      return true;
    } else {
      console.log('üîí Host: Page refresh - will restore DISABLED state when bot opens');
      return false;
    }
  } catch (err) {
    console.error('‚ùå Host: Failed to restore state:', err);
    return false;
  }
}

/**
 * Clear saved state from localStorage
 */
function clearSavedState() {
  try {
    localStorage.removeItem(STORAGE_KEY_INPUT_ENABLED);
    localStorage.removeItem(STORAGE_KEY_AGENT_COUNT);
    localStorage.removeItem(STORAGE_KEY_BOT_ALLOWED);
    localStorage.removeItem(STORAGE_KEY_TIMESTAMP);
    console.log('üßπ Host: Cleared saved state from localStorage');
  } catch (err) {
    console.error('‚ùå Host: Failed to clear saved state:', err);
  }
}

// Save state on page visibility change (more reliable than beforeunload on iOS)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden' && botOpened) {
    console.log('üëÅÔ∏è Host: Page hidden, saving state...');
    saveState();
  }
});

// Save state before page unload (backup, not reliable on iOS)
window.addEventListener('beforeunload', () => {
  console.log('üö™ Host: beforeunload fired, saving state...');
  saveState();
});

// Save state before page is frozen (iOS-specific event)
window.addEventListener('pagehide', () => {
  console.log('‚ùÑÔ∏è Host: pagehide fired, saving state...');
  saveState();
});

// Aggressive periodic saving (every 2 seconds when bot is open)
setInterval(() => {
  if (botOpened) {
    saveState();
  }
}, 2000);

// Restore state on load
const shouldRestoreEnabled = restoreStateFromStorage();

// Clear old state after 10 minutes
setTimeout(() => {
  clearSavedState();
}, 600000);

// ============================================================================
// MESSAGE EVENT HANDLER
// ============================================================================

window.addEventListener("message", function(event) {
  try {
    // Iframe initialization
    if (event.data === "iframe-ready") {
      console.log('‚úÖ Host: Bot opened - iframe ready signal received');
      botOpened = true;
      
      // Apply correct initial state based on restored state
      if (shouldRestoreEnabled && (agentCount > 0 || lastBotMessageAllowedInput)) {
        postIframeMessage("InputEnable");
        console.log('üîì Host: Restored enabled state after page refresh');
      } else {
        postIframeMessage("InputDisable");
        console.log('üîí Host: Applied disabled state on bot open');
      }
      
      saveState();
      return;
    }
    
    // Parse conversation events
    const details = event?.data?.data?.eventDetails?.conversationEntry;
    const payload = details?.entryPayload;
    const entryType = details?.entryType;
    const senderRole = details?.sender?.role;
    
    if (typeof payload !== "string") {
      return;
    }
    
    // Mark that bot has been opened
    if (!botOpened) {
      botOpened = true;
      console.log('‚úÖ Host: Bot opened - conversation events detected');
    }
    
    // Track agent participation changes
    if (entryType === EVENT_PARTICIPANT_CHANGED) {
      if (payload.includes(EVENT_OP_ADD) && payload.includes(EVENT_ROLE_AGENT)) {
        agentCount++;
        console.log('üë§ Host: Agent joined (count:', agentCount + ')');
        saveState();
      } else if (payload.includes(EVENT_OP_REMOVE) && payload.includes(EVENT_ROLE_AGENT)) {
        agentCount--;
        console.log('üëã Host: Agent left (count:', agentCount + ')');
        saveState();
      }
    }
    
    // Decision logic
    if (agentCount > 0) {
      postIframeMessage("InputEnable");
      lastBotMessageAllowedInput = false;
      saveState();
      return;
    }
    
    if (senderRole === "Chatbot" && payload.includes(BOT_FLAG_ENABLE)) {
      postIframeMessage("InputEnable");
      lastBotMessageAllowedInput = true;
      console.log('ü§ñ Host: Bot requested free-text input');
      saveState();
      return;
    }
    
    if (senderRole === "Chatbot" && !payload.includes(BOT_FLAG_ENABLE)) {
      postIframeMessage("InputDisable");
      lastBotMessageAllowedInput = false;
      console.log('ü§ñ Host: Bot in scripted mode (no free-text)');
      saveState();
      return;
    }
    
    if (payload.includes(EVENT_CLOSE_CONVERSATION)) {
      postIframeMessage("InputDisable");
      lastBotMessageAllowedInput = false;
      agentCount = 0;
      console.log('üîö Host: Conversation closed');
      clearSavedState();
      return;
    }
    
  } catch (err) {
    console.error("‚ùå Host: Error processing message event:", err);
    postIframeMessage("InputDisable");
  }
});

console.log('üöÄ Host: Input control script initialized');
</script>

<!-- Embedded Messaging Bootstrap Script -->
<script type='text/javascript'>
  window.addEventListener("onEmbeddedMessagingReady", e => {
    embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
      input_Country: "GB",
      input_ISOCountry: "GB",
      input_ChannelDetails: "Cory's UK HCP Upgrade Test"
    });
  });

	function initEmbeddedMessaging() {
		try {
			embeddedservice_bootstrap.settings.language = 'en_US'; // For example, enter 'en' or 'en-US'

			embeddedservice_bootstrap.init(
				'00D9V00000D7QJF',
				'PFZUKHCPMessaging',
				'https://pfizermedinfo--upgrade.sandbox.my.site.com/ESWPFZUKHCPMessaging1740668167388',
				{
					scrt2URL: 'https://pfizermedinfo--upgrade.sandbox.my.salesforce-scrt.com'
				}
			);
		} catch (err) {
			console.error('Error loading Embedded Messaging: ', err);
		}
	};
</script>
<script type='text/javascript' src='https://pfizermedinfo--upgrade.sandbox.my.site.com/ESWPFZUKHCPMessaging1740668167388/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>

</html>